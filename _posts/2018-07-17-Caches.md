---
layout: post
title: Guava Cache
date: 2018-07-17 20:10
---



>   ç¿»è¯‘è‡ªï¼šhttps://github.com/google/guava/wiki/CachesExplained

<!-- more -->

# Caches

## Example

```java
LoadingCache<Key, Graph> graphs = CacheBuilder.newBuilder()
       .maximumSize(1000)
       .expireAfterWrite(10, TimeUnit.MINUTES)
       .removalListener(MY_LISTENER)
       .build(
           new CacheLoader<Key, Graph>() {
             public Graph load(Key key) throws AnyException {
               return createExpensiveGraph(key);
             }
           });
```

## ä½¿ç”¨èŒƒå›´

ç¼“å­˜åœ¨å¤šé‡åœºæ™¯ä¸‹éƒ½éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå½“è®¡ç®—æˆ–è€…è·å–æŸä¸ªå€¼çš„ä»£ä»·éå¸¸æ˜‚è´µï¼Œå¹¶ä¸”ä½ ä¸æ­¢ä¸€æ¬¡ä¼šè·å–å®ƒï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œä½ åº”è¯¥è€ƒè™‘ä½¿ç”¨ç¼“å­˜ã€‚

`Cache` è·Ÿ `ConcurrentMap` ç±»ä¼¼ï¼Œä½†æ˜¯ä¸å®Œå…¨ç›¸åŒã€‚æœ€å¤§çš„ä¸åŒåœ¨äº `ConcurrentMap` ä¸­çš„å€¼éœ€è¦æ‰‹åŠ¨ç§»é™¤ã€‚å¯¹äº `Cache` æ¥è¯´ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨é©±é™¤ç¼“å­˜çš„æ¡ç›®æ¥å‡å°‘å¯¹å†…å­˜çš„å ç”¨ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ`LoadingCache` ä¼šéå¸¸æœ‰ç”¨ï¼Œå³ä½¿å®ƒä¸å»åˆ é™¤æ¡ç›®ï¼Œä½†æ˜¯ä¼šè‡ªåŠ¨åŠ è½½ç¼“å­˜ã€‚

ä¸€èˆ¬æ¥è¯´ Guava ç¼“å­˜åœ¨ä»¥ä¸‹åœºæ™¯ä¸­å¯ä»¥åº”ç”¨ï¼š

-   é€šè¿‡å†…å­˜æ¥æé«˜è®¿é—®é€Ÿåº¦
-   å¤šæ¬¡é€šè¿‡æŸä¸ª key æ¥è®¿é—®æ•°æ®
-   ç¼“å­˜ä¸­å­˜å‚¨çš„æ•°æ®ä¸ä¼šæ¯” RAM è¿˜è¦å¤šã€‚ï¼ˆGuava çš„ç¼“å­˜å­˜åœ¨ä½ æœ¬åœ°çš„åº”ç”¨ä¸Šã€‚ä¸ä¼šå­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…å¤–éƒ¨çš„æœåŠ¡å™¨ä¸Šã€‚å¦‚æœè¿™ä¸ªæ»¡è¶³ä¸äº†ä½ çš„éœ€æ±‚ï¼Œè¯·è€ƒè™‘ [Memcached](http://memcached.org/) 

å¦‚æœä¸Šé¢è¿™äº›éƒ½ç¬¦åˆä½ çš„åœºæ™¯ï¼Œé‚£ä¹ˆ Guava ç¼“å­˜éå¸¸é€‚åˆä½ ã€‚

é€šè¿‡ `CacheBuilder` ç”Ÿæˆå™¨æ¨¡å¼å¯ä»¥è·å–ä¸€ä¸ª `Cahceï¼Œ`å¦‚ä¸Šé¢çš„ç¤ºä¾‹ã€‚ä½†æ˜¯å®šåˆ¶è‡ªå·±çš„ç¼“å­˜æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„è¿‡ç¨‹ã€‚ï¼ˆè¡¨ç¤ºæ„Ÿè§‰ä¸åˆ°ï¼‰

*æ³¨æ„ï¼š*å¦‚æœä½ ä¸éœ€è¦ `Cache` æä¾›çš„ç‰¹æ€§ã€‚é‚£ä¹ˆ `ConcurrentHashMap` æœ‰æ›´é«˜çš„å†…å­˜æ•ˆç‡ã€‚ä½†æ˜¯é€šè¿‡æ—§çš„ `ConcurrentMap` éš¾ä»¥ç”šè‡³ä¸å¯èƒ½å¤åˆ¶ `Cache` çš„ç‰¹æ€§ã€‚

## æ€»è§ˆ

åœ¨ä½¿ç”¨ç¼“å­˜å‰ï¼Œå…ˆé—®è‡ªå·±ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šæ˜¯å¦æœ‰é»˜è®¤çš„æ–¹æ³•é€šè¿‡ä¸€ä¸ª key å»åŠ è½½æˆ–è€…è®¡ç®— valueï¼Ÿå¦‚æœæœ‰çš„è¯ï¼Œä½ åº”è¯¥ä½¿ç”¨ `CacheLoader`ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæˆ–è®¸ä½ åº”è¯¥é‡å†™é»˜è®¤çš„æ–¹æ³•ï¼Œä½†æ˜¯ä½ ä¾ç„¶æƒ³è¦åŸå­çš„ "å¦‚æœä¸å­˜åœ¨åˆ™è®¡ç®—" è¯­ä¹‰ï¼Œé‚£ä¹ˆä½ åº”è¯¥å°† `Callable` ä¼ é€’ç»™ `get` æ¥è°ƒç”¨ã€‚è°ƒç”¨ `Cache.put` å¯ä»¥ç›´æ¥å°†å…ƒç´ æ’å…¥åˆ°ç¼“å­˜ï¼Œä½†æ˜¯è‡ªåŠ¨åŠ è½½ç¼“å­˜æ˜¯é¦–é€‰ï¼Œå› ä¸ºå®ƒæ›´å®¹æ˜“åœ¨æ‰€æœ‰å†…å®¹ä¸Šä¿æŒç¼“å­˜ä¸€è‡´æ€§ã€‚

#### CacheLoader

`LoadingCache` æ˜¯ä¸€ä¸ªé™„åŠ äº† `CacheLoader` çš„ `Cache`ã€‚åˆ›å»ºä¸€ä¸ª `CacheLoader` æœ€å…¸å‹çš„æ–¹æ³•å°±æ˜¯å®ç°æ–¹æ³• `V load(K key) throws Exception`ã€‚å¦‚ä¸‹æœ‰ä¸€ä¸ªåˆ›å»º `LoadingCache` çš„ç¤ºä¾‹ï¼š

```java
LoadingCache<Key, Graph> graphs = CacheBuilder.newBuilder()
       .maximumSize(1000)
       .build(
           new CacheLoader<Key, Graph>() {
             public Graph load(Key key) throws AnyException {
               return createExpensiveGraph(key);
             }
           });

...
try {
  return graphs.get(key);
} catch (ExecutionException e) {
  throw new OtherException(e.getCause());
}
```

æŸ¥è¯¢ `LoadingCache` å…¸å‹çš„æ–¹å¼ä¸ºé€šè¿‡ `get(K)` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å°†ä¼šè¿”å›ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç¼“å­˜å€¼ï¼Œæˆ–è€…é€šè¿‡ `CacheLoader` è‡ªåŠ¨çš„åŠ è½½ä¸€ä¸ªæ–°çš„å€¼åˆ°ç¼“å­˜ä¸­ã€‚`CacheLoader` å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ`LoadingCache.get(K)` ä¼šæŠ›å‡º `ExecutionException`ã€‚ï¼ˆå¦‚æœ CacheLoader æŠ›å‡ºä¸€ä¸ª *æœªæ£€æŸ¥å¼‚å¸¸*ï¼Œ`get(K)` å°†ä¼šç”¨ä¸€ä¸ª `UncheckedExecutionException` åŒ…è£¹å®ƒã€‚ï¼‰ä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨ `getUnchecked(K)`ï¼Œå®ƒå°†é€šè¿‡ `UncheckedExecutionException` åŒ…è£¹æ‰€æœ‰çš„å¼‚å¸¸ï¼Œä½†æ˜¯è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å¥‡æ€ªçš„è¡Œä¸ºï¼Œå› ä¸º `CacheLoader` ä¼šæŠ›å‡ºå¯æ£€æŸ¥å¼‚å¸¸ã€‚

```java
LoadingCache<Key, Graph> graphs = CacheBuilder.newBuilder()
       .expireAfterAccess(10, TimeUnit.MINUTES)
       .build(
           new CacheLoader<Key, Graph>() {
             public Graph load(Key key) { // no checked exception
               return createExpensiveGraph(key);
             }
           });

...
return graphs.getUnchecked(key);
```

å¯ä»¥é€šè¿‡ä½¿ç”¨ `getAll(Iterable<? extends K>)` æ¥è¿›è¡Œæ‰¹é‡æŸ¥è¯¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`getAll` ä¼šä¸ºæ¯ä¸ª key åˆ†åˆ«å»è°ƒç”¨ `CacheLoader.load`ï¼Œå¦‚æœè¯¥ key å¯¹åº”çš„å€¼åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ã€‚å½“æ‰¹é‡æŸ¥è¯¢æ¯”å¤šæ¬¡å•è¯å•ç‹¬æŸ¥è¯¢æœ‰æ•ˆæ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©é‡å†™ `CacheLoader.loadAll` ã€‚`getAll(Iterable)` çš„æ€§èƒ½å°†ä¼šç›¸åº”çš„æé«˜ã€‚

æ³¨æ„ï¼šä½ å¯ä»¥å®ç°ä¸€ä¸ª `CacheLoader.loadAll` æ¥åŠ è½½æœªè¢«æŒ‡å®šçš„ key çš„ valueã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä¸ºç»„ä¸­ä¸€éƒ¨åˆ† key è®¡ç®— valueï¼Œä½†æ˜¯è¿™äº› value æ˜¯ç»„ä¸­æ‰€æœ‰ key çš„å€¼ï¼Œé‚£ä¹ˆ `loadAll` å°†ä¼šåŒæ—¶åŠ è½½ç»„ä¸­å‰©ä½™çš„ keyã€‚

>   æœ€åçš„è¿™ä¸ªæ³¨æ„äº‹é¡¹ç¿»è¯‘çš„è´¼åˆ«æ‰­ï¼Œçœ‹ä¸æ‡‚çš„å»çœ‹åŸæ–‡

#### Callable

æ‰€æœ‰çš„ Guava ç¼“å­˜ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯ loading cacheï¼Œéƒ½æ”¯æŒ `get(K, Callable<V)` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ç¼“å­˜ä¸­ key å¯¹åº”çš„ valueï¼Œæˆ–è€…é€šè¿‡æŒ‡å®šçš„ `Callable` æ–¹æ³•é‡æ–°è®¡ç®— valueï¼Œå¹¶æ’å…¥åˆ°ç¼“å­˜ä¸­ã€‚åœ¨ç¼“å­˜å®Œå…¨åŠ è½½ä¹‹å‰ï¼Œä¸ä¼šä¿®æ”¹ç¼“å­˜çš„å¯è§‚å¯ŸçŠ¶æ€ã€‚è¿™ä¸ªæ–¹æ³•ä¸ºä¼ ç»Ÿçš„ "å¦‚æœç¼“å­˜äº†ï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™å°±å°±åˆ›å»ºï¼Œç„¶åç¼“å­˜å¹¶è¿”å›" æ¨¡å¼æä¾›äº†ä¸€ä¸ªç®€å•çš„æ›¿ä»£æ–¹æ³•ã€‚

```java
Cache<Key, Value> cache = CacheBuilder.newBuilder()
    .maximumSize(1000)
    .build(); // look Ma, no CacheLoader
...
try {
  // If the key wasn't in the "easy to compute" group, we need to
  // do things the hard way.
  cache.get(key, new Callable<Value>() {
    @Override
    public Value call() throws AnyException {
      return doThingsTheHardWay(key);
    }
  });
} catch (ExecutionException e) {
  throw new OtherException(e.getCause());
}
```

#### ç›´æ¥æ’å…¥

é€šè¿‡ [`cache.put(key, value)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/Cache.html#put-K-V-) å¯ä»¥ç›´æ¥å°†æ•°æ®æ’å…¥åˆ°ç¼“å­˜ä¸­ã€‚è¯¥æ–¹æ³•ä¼šé‡å†™æŒ‡å®šçš„ key åœ¨ç¼“å­˜ä¸­æ‰€å¯¹åº”çš„é”®å€¼å¯¹ã€‚`Cache.asMap()` æš´éœ²çš„è§†å›¾ï¼Œå¯ä»¥é€šè¿‡ `ConcurrentMap` æ–¹æ³•å¯¹ç¼“å­˜è¿›è¡Œæ›´æ”¹ã€‚æ³¨æ„ï¼Œ`asMap` è§†å›¾ä¸Šçš„ä»»ä½•æ–¹æ³•éƒ½ä¸ä¼šå¯¼è‡´ç¼“å­˜è‡ªåŠ¨åŠ è½½ã€‚è€Œä¸”ï¼Œè¯¥è§†å›¾ä¸Šé¢çš„åŸå­æ“ä½œè¶…å‡ºäº†ç¼“å­˜è‡ªåŠ¨åŠ è½½çš„èŒƒå›´ã€‚æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯é€šè¿‡ `CacheLoader` æˆ– `Callable`ï¼Œ `Cache.get(K, Callable<V)` åº”è¯¥æ€»æ˜¯ä¼˜äº `Cache.asMap().putIfAbsent`ã€‚

## ç¼“å­˜å›æ”¶

ç°å®æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥ç¼“å­˜æ‰€æœ‰çš„ä¸œè¥¿ã€‚ä½ å¿…é¡»å†³å®šä»€ä¹ˆä¸œè¥¿å€¼å¾—ç¼“å­˜ï¼ŸGuava æä¾›äº†ä¸‰ä¸­ç±»å‹çš„å›æ”¶ç­–ç•¥ï¼šåŸºäºå¤§å°ï¼ŒåŸºäºæ—¶é—´ï¼ŒåŸºäºå¼•ç”¨ã€‚

### (åŸºäºå¤§å°) Size-based Eviction

å¦‚æœä½ ä¸æƒ³è®©ä½ çš„ç¼“å­˜è¶…è¿‡å›ºå®šå¤§å°ï¼Œå¯ä»¥ä½¿ç”¨ `CacheBuilder.maximumSize(long)`ã€‚ç¼“å­˜å°†ä¼šå°è¯•å›æ”¶æœ€è¿‘æˆ–è€…ç»å¸¸æ²¡æœ‰è¢«ç”¨åˆ°çš„æ•°æ®ã€‚*è­¦å‘Š*ï¼šç¼“å­˜å¯èƒ½ä¼šåœ¨è¶…è¿‡å›ºå®šå¤§å°ä¹‹å‰è¿›è¡Œå›æ”¶å·¥ä½œ --- å…¸å‹çš„æƒ…å†µæ˜¯ç¼“å­˜çš„å¤§å°æ¥è¿‘é™å®šçš„å¤§å°ã€‚

å¦‚æœç¼“å­˜æ¡ç›®æœ‰ä¸åŒçš„ "æƒé‡"ã€‚ä¾‹å¦‚ï¼šå¦‚æœä½ ç¼“å­˜æœ‰å®Œå…¨ä¸åŒçš„å†…å­˜å ç”¨ã€‚ä½ åº”è¯¥æŒ‡å®šæƒé‡å‡½æ•° [`CacheBuilder.weigher(Weigher)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#weigher-com.google.common.cache.Weigher-) ä¸æœ€å¤§ç¼“å­˜æƒé‡ [`CacheBuilder.maximumWeight(long)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#maximumWeight-long-)ã€‚é™¤äº†ä¸ `maximumSize` çš„è­¦å‘Šç›¸åŒæ„å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„æ¯ä¸ªæ¡ç›®çš„æƒé‡åœ¨åˆ›å»ºæ—¶è®¡ç®—ï¼Œä¹‹åéƒ½æ˜¯ä¸å˜çš„ã€‚

### (åŸºäºæ—¶é—´) Timed Eviction

`CacheBuilder` æä¾›äº†ä¸¤ä¸ªæ–¹æ³•å»é€šè¿‡æ—¶é—´å›æ”¶ï¼š

- [`expireAfterAccess(long, TimeUnit)`](https://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#expireAfterAccess-long-java.util.concurrent.TimeUnit-) å½“ä¸€ä¸ªæ¡ç›®æœ€è¿‘è¢«è¯»å–æˆ–è€…å†™å…¥ï¼Œåœ¨ç»è¿‡äº†æŒ‡å®šæ—¶é—´ä¹‹åå°†ä¼šè¿‡æœŸã€‚æ³¨æ„ï¼Œå†³å®šå›æ”¶å“ªä¸ªæ¡ç›®ä¸[åŸºäºå¤§å°](/#(åŸºäºå¤§å°) Size-based Eviction)çš„ç­–ç•¥ç±»ä¼¼ã€‚
- [`expireAfterWrite(long, TimeUnit)`](https://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#expireAfterWrite-long-java.util.concurrent.TimeUnit-) å½“ä¸€ä¸ªæ¡ç›®è¢«åˆ›å»ºæˆ–æœ€è¿‘ä¸€æ¬¡è¢«æ›¿æ¢ï¼Œåœ¨ç»è¿‡äº†æŒ‡å®šæ—¶é—´ä¹‹åå°†ä¼šè¿‡æœŸã€‚å¦‚æœç¼“å­˜åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åå˜å¾—é™ˆæ—§ï¼Œè¯¥ç­–ç•¥æ˜¯å¯å–çš„ã€‚

åœ¨å‘¨æœŸæ€§çš„å†™ä»¥åŠå¶å°”æ€§çš„è¯»ä¹‹é—´æ‰§è¡Œå®šæ—¶è¿‡æœŸï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚

#### åŸºäºæ—¶é—´å›æ”¶çš„æµ‹è¯•

åŸºäºæ—¶é—´å›æ”¶çš„æµ‹è¯•ä¸ä¼šå˜å¾—å¾ˆç—›è‹¦ï¼Œä½ ä¸éœ€è¦èŠ±ä¸¤ç§’é’Ÿæ¥æµ‹è¯•ä¸€ä¸ªä¸¤ç§’é’Ÿçš„è¿‡æœŸæ—¶é—´ã€‚åœ¨ä½ çš„ cache builder ä¸­ä½¿ç”¨ [Ticker](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/base/Ticker.html) æ¥å£ä»¥åŠ [`CacheBuilder.ticker(Ticker)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#ticker-com.google.common.base.Ticker-) æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç­‰å¾…ç³»ç»Ÿçš„æ—¶é—´ã€‚

### (åŸºäºå¼•ç”¨) Reference-based Eviction

Guava å…è®¸ä½ è®¾ç½®ç¼“å­˜è®©åƒåœ¾å›æ”¶å™¨å¯ä»¥è¿›è¡Œå›æ”¶ï¼Œé€šè¿‡ä½¿ç”¨[å¼±å¼•ç”¨](http://docs.oracle.com/javase/6/docs/api/java/lang/ref/WeakReference.html)çš„ key æˆ–è€… valueï¼Œä»¥åŠ[è½¯å¼•ç”¨](http://docs.oracle.com/javase/6/docs/api/java/lang/ref/SoftReference.html)çš„ valueã€‚

- [`CacheBuilder.weakKeys()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#weakKeys--) é€šè¿‡å¼±å¼•ç”¨æ¥å­˜å‚¨ keyã€‚å¦‚æœæ¡ç›®æ²¡æœ‰å…¶ä»–å¯¹ key çš„å¼•ç”¨ (å¼ºå¼•ç”¨æˆ–è€…è½¯å¼•ç”¨)ï¼Œå…è®¸åƒåœ¾å›æ”¶å™¨è¿›è¡Œå›æ”¶ã€‚å› ä¸ºåƒåœ¾å›æ”¶å™¨ä¾èµ–äºç›¸ç­‰çš„æ ‡è¯†ï¼Œæ‰€ä»¥å¯¼è‡´æ•´ä¸ªç¼“å­˜éƒ½æ˜¯ç”¨ (`==`) æ¥æ¯”è¾ƒ keyï¼Œè€Œä¸æ˜¯é€šè¿‡ `equals()`ã€‚
- [`CacheBuilder.weakValues()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#weakValues--) é€šè¿‡å¼±å¼•ç”¨æ¥å­˜å‚¨ valueã€‚å¦‚æœåœ¨æ²¡æœ‰å…¶å®ƒå¼•ç”¨ï¼ˆå¼ºå¼•ç”¨æˆ–è€…è½¯å¼•ç”¨ï¼‰çš„æƒ…å†µä¸‹ï¼Œå…è®¸åƒåœ¾å›æ”¶å™¨æ¥è¿›è¡Œå›æ”¶ã€‚å› ä¸ºåƒåœ¾å›æ”¶å™¨ä¾èµ–äºç›¸ç­‰çš„æ ‡è¯†ï¼Œæ‰€ä»¥å¯¼è‡´æ•´ä¸ªç¼“å­˜éƒ½æ˜¯ç”¨ (`==`) æ¥æ¯”è¾ƒ keyï¼Œè€Œä¸æ˜¯é€šè¿‡ `equals()`ã€‚
- [`CacheBuilder.softValues()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#softValues--) é€šè¿‡è½¯å¼•ç”¨å¯¹ value è¿›è¡ŒåŒ…è£…ã€‚åƒåœ¾å›æ”¶å™¨æ ¹æ®å†…å­˜çš„éœ€è¦ï¼Œé€šè¿‡æœ€è¿‘æœ€å°‘ä½¿ç”¨æ–¹å¼å¯¹è½¯å¼•ç”¨å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚ç”±äºä½¿ç”¨è½¯å¼•ç”¨æ—¶çš„æ€§èƒ½å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬å»ºè®®æŒ‡å®šç¼“å­˜çš„æœ€å¤§å¤§å°ã€‚ä½¿ç”¨ `softValues()` å°†ä¼šå¯¼è‡´ value é—´çš„æ¯”è¾ƒä½¿ç”¨ (`==`) è€Œä¸æ˜¯ `equals()`ã€‚

### åˆ é™¤ç¼“å­˜

åœ¨ä»»ä½•æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ˜¾å¼çš„æŒ‡å®šç¼“å­˜æ¡ç›®æ— æ•ˆï¼Œè€Œä¸ç”¨ç­‰å¾…æ¡ç›®è‡ªåŠ¨è¿‡æœŸã€‚

å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š

- é’ˆå¯¹å•ä¸ªæ¡ç›®ã€‚ä½¿ç”¨ [`Cache.invalidate(key)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/Cache.html#invalidate-java.lang.Object-)
- é’ˆå¯¹æ‰¹é‡æ¡ç›®ã€‚ä½¿ç”¨ [`Cache.invalidateAll(keys)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/Cache.html#invalidateAll-java.lang.Iterable-)
- é’ˆå¯¹å…¨éƒ¨æ¡ç›®ã€‚ä½¿ç”¨ [`Cache.invalidateAll()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/Cache.html#invalidateAll--)

### ç§»é™¤ç›‘å¬å™¨

ä½ å¯ä»¥é€šè¿‡ [`CacheBuilder.removalListener(RemovalListener)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#removalListener-com.google.common.cache.RemovalListener-) æŒ‡å®šä¸€ä¸ªç§»é™¤ç›‘å¬å™¨ï¼Œåœ¨ç¼“å­˜æ¡ç›®å¤±æ•ˆçš„æ—¶å€™åšäº›å…¶å®ƒçš„æ“ä½œã€‚[`RemovalListener`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/RemovalListener.html) é€šè¿‡ä¼ é€’ä¸€ä¸ª [`RemovalNotification`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/RemovalNotification.html) æ¥è·å– [`RemovalCause`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/RemovalCause.html)ï¼Œkey ä»¥åŠ valueã€‚

æ³¨æ„ `RemovalListener` è·‘å‡ºæ¥çš„ä»»ä½•å¼‚å¸¸å¯ä»¥è¢«æ‰“å°ï¼ˆä½¿ç”¨ Loggerï¼‰æˆ–è€…è¢«åæ‰ã€‚

```java
CacheLoader<Key, DatabaseConnection> loader = new CacheLoader<Key, DatabaseConnection> () {
  public DatabaseConnection load(Key key) throws Exception {
    return openConnection(key);
  }
};
RemovalListener<Key, DatabaseConnection> removalListener = new RemovalListener<Key, DatabaseConnection>() {
  public void onRemoval(RemovalNotification<Key, DatabaseConnection> removal) {
    DatabaseConnection conn = removal.getValue();
    conn.close(); // tear down properly
  }
};

return CacheBuilder.newBuilder()
  .expireAfterWrite(2, TimeUnit.MINUTES)
  .removalListener(removalListener)
  .build(loader);
```

**æé†’**ï¼šç§»é™¤ç›‘å¬å™¨é»˜è®¤æ˜¯åŒæ­¥ (synchronously) æ‰§è¡Œçš„ã€‚å› ä¸ºç¼“å­˜çš„ç»´æŠ¤å·¥ä½œæ˜¯åœ¨ç¼“å­˜çš„æ­£å¸¸æ“ä½œæœŸé—´æ‰§è¡Œçš„ã€‚ä»£ä»·æ¯”è¾ƒé«˜çš„ç§»é™¤ç›‘å¬å™¨æ“ä½œä¼šå½±å“ç¼“å­˜çš„æ­£å¸¸åŠŸèƒ½ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªä»£ä»·æ¯”è¾ƒé«˜çš„ç§»é™¤ç›‘å¬å™¨ï¼Œä½¿ç”¨ [`RemovalListeners.asynchronous(RemovalListener, Executor)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/RemovalListeners.html#asynchronous-com.google.common.cache.RemovalListener-java.util.concurrent.Executor-) åŒ…è£… `RemovalListener`ï¼Œè®©å®ƒå¼‚æ­¥æ‰§è¡Œã€‚

### ç¼“å­˜æ¸…ç†å‘ç”Ÿçš„æ—¶æœº

`CacheBuilder` æ„å»ºçš„ç¼“å­˜ä¸ä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ valuesï¼Œä¹Ÿä¸ä¼šåœ¨ value å¤±æ•ˆåå°±é©¬ä¸Šæ¸…ç†ï¼Œæˆ–è€…å…¶å®ƒç±»ä¼¼çš„äº‹æƒ…ã€‚ç›¸åçš„ï¼Œå®ƒä¼šåœ¨å†™æ“ä½œæœŸé—´ï¼Œæ‰§è¡Œå°‘é‡çš„ç»´ä¿®å·¥ä½œï¼Œæˆ–è€…åœ¨å†™æ“ä½œå¾ˆå°‘çš„æƒ…å†µä¸‹ï¼Œå¶å°”è¯»çš„æ—¶å€™æ‰§è¡Œç»´ä¿®å·¥ä½œã€‚

è¿™æ ·åšçš„åŸå› å¦‚ä¸‹ï¼šå¦‚æœæˆ‘ä»¬é¢‘ç¹çš„æ‰§è¡Œ `Cache` çš„ç»´ä¿®å·¥ä½œï¼Œæˆ‘éœ€è¦å»åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒçš„æ“ä½œä¼šä¸ç”¨æˆ·çš„æ“ä½œç«äº‰å…±äº«é”ã€‚å¦å¤–ï¼ŒæŸäº›ç¯å¢ƒä¸‹ä¸¥æ ¼é™åˆ¶äº†çº¿ç¨‹åˆ›å»ºçš„æ•°é‡ï¼Œè¿™å°†å¯¼è‡´ `CacheBuilder` åœ¨è¿™ç§æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ã€‚

ç›¸åï¼Œæˆ‘ä»¬æŠŠé€‰æ‹©æƒäº¤åˆ°ä½ çš„æ‰‹é‡Œã€‚å¦‚æœä½ çš„ç¼“å­˜æ˜¯é«˜ååé‡çš„ï¼Œé‚£ä¹ˆä½ ä¸ç”¨å»æ‹…å¿ƒæ‰§è¡Œæ¸…ç†ç¼“å­˜ä¸­è¿‡æœŸæ¡ç›®ä¹‹ç±»çš„ç»´æŠ¤å·¥ä½œã€‚å¦‚æœä½ çš„ç¼“å­˜å¾ˆå°‘å†™ï¼Œå¹¶ä¸”ä½ ä¸æƒ³æ¸…ç†æ¥ç»„ç»‡ç¼“å­˜çš„è¯»ã€‚ä½ å¯ä»¥é€šè¿‡å®šæœŸçš„è°ƒç”¨ [`Cache.cleanUp()`](http://google.github.io/guava/releases/11.0.1/api/docs/com/google/common/cache/Cache.html#cleanUp--) æ¥åˆ›å»ºä½ è‡ªå·±çš„ç»´æŠ¤çº¿ç¨‹ã€‚

å¦‚æœä½ æƒ³ä¸ºä¸€ä¸ªå¾ˆå°‘å†™çš„ç¼“å­˜å®šæœŸçš„æ‰§è¡Œç»´æŠ¤å·¥ä½œï¼Œå¯ä»¥ä½¿ç”¨ [`ScheduledExecutorService`](http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html) æ¥æ‰§è¡Œå®šæœŸç»´æŠ¤ã€‚

### åˆ·æ–° (Refresh)

åˆ·æ–°è·Ÿç§»é™¤ä¸ä¸€æ ·ã€‚åœ¨ [`LoadingCache.refresh(K)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/LoadingCache.html#refresh-K-) æŒ‡å®šä¸€ä¸ª keyï¼Œä¸ºè¿™ä¸ª key åŠ è½½ä¸€ä¸ªæ–°å€¼ï¼Œå¯èƒ½ä¼šæ˜¯å¼‚æ­¥åŠ è½½ã€‚å½“ key è¢«åˆ·æ–°æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ªæ—§å€¼ã€‚ä¸ç§»é™¤ç›¸åçš„æ˜¯ï¼Œåˆ·æ–°ä¼šå¼ºåˆ¶æŸ¥è¯¢ç­‰å¾…ï¼Œç›´åˆ°æ–°å€¼è¢«åŠ è½½ã€‚

å¦‚æœåœ¨åˆ·æ–°æœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆæ—§å€¼ä¼šä¿ç•™ï¼Œå¼‚å¸¸ä¼šè¢«æ‰“å°å¹¶è¢«åæ‰ã€‚

ä½¿ç”¨åˆ·æ–°çš„æ—¶å€™ï¼Œé€šè¿‡é‡å†™ [`CacheLoader.reload(K, V) `](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheLoader.html#reload-K-V-) æ¥ä¸º `CacheLoader` æŒ‡å®šä¸€ä¸ªæ˜æ™ºçš„è¡Œä¸ºï¼Œè¿™å°†å…è®¸ä½ åœ¨è®¡ç®—æ–°å€¼çš„æ—¶å€™ä½¿ç”¨æ—§å€¼ã€‚

```java
// ä¸€äº› key æ˜¯ä¸éœ€è¦è¢«åˆ·æ–°çš„ï¼Œæˆ‘ä»¬å¸Œæœ›åˆ·æ–°æ˜¯å¼‚æ­¥æ‰§è¡Œçš„
LoadingCache<Key, Graph> graphs = CacheBuilder.newBuilder()
       .maximumSize(1000)
       .refreshAfterWrite(1, TimeUnit.MINUTES)
       .build(
           new CacheLoader<Key, Graph>() {
             public Graph load(Key key) { // éæ£€æŸ¥å¼‚å¸¸
               return getGraphFromDatabase(key);
             }

             public ListenableFuture<Graph> reload(final Key key, Graph prevGraph) {
               if (neverNeedsRefresh(key)) {
                 return Futures.immediateFuture(prevGraph);
               } else {
                 // asynchronous!
                 ListenableFutureTask<Graph> task = ListenableFutureTask.create(new Callable<Graph>() {
                   public Graph call() {
                     return getGraphFromDatabase(key);
                   }
                 });
                 executor.execute(task);
                 return task;
               }
             }
           });
```

è‡ªåŠ¨å®šæ—¶åˆ·æ–°é€šè¿‡ä½¿ç”¨ [`CacheBuilder.refreshAfterWrite(long, TimeUnit)`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheBuilder.html#refreshAfterWrite-long-java.util.concurrent.TimeUnit-) æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚ä¸ `expireAfterWrite` ç›¸åçš„æ˜¯ `refreshAfterWrite` ä¼šæŒ‡å®šæ—¶é—´ä¹‹åé€‚å½“çš„å¯¹ key è¿›è¡Œåˆ·æ–°ï¼Œä½†æ˜¯åˆ·æ–°çœŸæ­£çš„åˆå§‹åŒ–æ˜¯åœ¨æ¡ç›®è¢«æŸ¥è¯¢çš„æ—¶å€™ã€‚(å¦‚æœ `CacheLoader.reload` çš„å®ç°ä¸ºå¼‚æ­¥ï¼Œé‚£ä¹ˆæŸ¥è¯¢ä¸ä¼šå‡æ…¢åˆ·æ–°çš„é€Ÿåº¦)ã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ä¸ªç¼“å­˜ä¸­åŒæ—¶æŒ‡å®š `refreshAfterWrite` ä¸ `expireAfterWrite`ã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ªæ¡ç›®å¯ä»¥è¢«åˆ·æ–°çš„æ—¶å€™ï¼Œå®ƒçš„è¿‡æœŸè®¡æ—¶å™¨ä¸ä¼šè¢«ç›²ç›®è¢«é‡ç½®ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªæ¡ç›®åœ¨å’Œå¯ä»¥è¢«åˆ·æ–°çš„æ—¶å€™æ²¡æœ‰è¢«æŸ¥è¯¢ï¼Œå°†ä¼šè¿‡æœŸã€‚

## ç‰¹ç‚¹

### ç»Ÿè®¡

é€šè¿‡ [`CacheBuilder.recordStats()`](http://google.github.io/guava/releases/12.0/api/docs/com/google/common/cache/CacheBuilder.html#recordStats--)ï¼Œä½ å¯ä»¥å¼€å¯å¯¹ Guava cache çš„ç»Ÿè®¡ã€‚[`Cache.stats()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/Cache.html#stats--) æ–¹æ³•è¿”å›ä¸€ä¸ª [`CacheStats`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheStats.html) å¯¹è±¡ï¼Œæä¾›äº†å¦‚ä¸‹çš„ç»Ÿè®¡æ–¹å¼ï¼š

- [`hitRate()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheStats.html#hitRate--) è¿”å›è¯·æ±‚å‘½ä¸­ç‡
- [`averageLoadPenalty()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheStats.html#averageLoadPenalty--) åŠ è½½æ–°å€¼çš„å¹³å‡æ—¶é—´ï¼Œå•ä½ä¸ºçº³ç§’
- [`evictionCount()`](http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/cache/CacheStats.html#evictionCount--) è¢«ç§»é™¤ç¼“å­˜çš„æ•°é‡

é™¤äº†è¿™äº›ä¹‹å¤–è¿˜æœ‰è®¸å¤šç»Ÿè®¡æ–¹å¼ã€‚è¿™äº›ç»Ÿè®¡å¯ä»¥ç”¨æ¥ç¼“å­˜è°ƒä¼˜ã€‚æˆ‘ä»¬å»ºè®®åœ¨å¯¹æ€§èƒ½æœ‰è¦æ±‚çš„åº”ç”¨ä¸Šå¯¹è¿™äº›ç»Ÿè®¡ä¿æŒå…³æ³¨ã€‚

### `asMap`

ä½ å¯ä»¥ä½¿ç”¨ `asMap` è§†å›¾å°† `Cache` å½“ä½œ `ConcurrentMap` æ¥æŸ¥çœ‹ã€‚ä½†æ˜¯ `asMap` è§†å›¾ä¸ `Cache` çš„ç›¸äº’ä½œç”¨éœ€è¦ä¸€äº›è§£é‡Šï¼š

- `cache.asMap()` åŒ…å«å½“å‰ç¼“å­˜ä¸­å·²ç»åŠ è½½çš„æ¡ç›®ã€‚æ‰€ä»¥ï¼Œ`cache.asMap().keySet()` åŒ…å«å½“å‰æ‰€åŠ è½½çš„æ‰€æœ‰çš„  keyã€‚
- `asMap().get(key)` æœ¬è´¨ä¸Šè·Ÿ `cache.getIfPresent(key)` ç›¸ç­‰ï¼Œå¹¶ä¸”ä¸ä¼šå¯¼è‡´å€¼é‡æ–°è¢«åŠ è½½ã€‚è¿™ä¸ `Map` æ˜¯ä¸€è‡´çš„ã€‚
- ç¼“å­˜çš„è¯»å†™æ“ä½œä¼šé‡ç½®è®¿é—®æ—¶é—´ (åŒ…æ‹¬ `Cache.asMap().get(Object)` ä¸ `Cache.asMap().put(K, V)`)ï¼Œä½†æ˜¯ `containsKey(Object)` ä¸ä¼šï¼ŒåŒæ ·çš„ `Cache.asMap()` ä¹Ÿä¸ä¼šã€‚æ‰€ä»¥ï¼Œé€šè¿‡ `cache.asMap().entrySet()` æ¥è¿­ä»£ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ä¸ä¼šé‡ç½®è®¿é—®æ—¶é—´ã€‚

## ä¸­æ–­ (Interruption)

åŠ è½½æ–¹æ³• (åƒ `get`) æ°¸è¿œä¸ä¼šæŠ›å‡º `InterruptedException`ã€‚æˆ‘ä»¬å¯ä»¥è®¾è®¡è¿™äº›æ–¹æ³•æ”¯æŒ `InterruptedException`ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ”¯æŒè¿˜ä¸å®Œæ•´ã€‚å°†æˆæœ¬å¼ºåŠ ç»™ç”¨æˆ·ï¼Œä½†æ˜¯åªä¼šç»™å°‘éƒ¨åˆ†ç”¨æˆ·å¸¦æ¥å¥½å¤„ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š

`get` è°ƒç”¨è¯·æ±‚ä¸ä¼šç¼“å­˜å€¼åˆ†æˆä¸¤å¤§ç±»ï¼šåŠ è½½å€¼ä»¥åŠç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹åŠ è½½ã€‚ä¸åŒç‚¹åœ¨äºæˆ‘ä»¬å¯¹ä¸­æ–­çš„æ”¯æŒã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹å»åŠ è½½ï¼šè¿™æ—¶æˆ‘ä»¬å¯ä»¥è¿›å…¥ä¸€ä¸ªå¯ä¸­æ–­çš„ç­‰å¾…ã€‚æœ€å›°éš¾çš„æ–¹å¼æ˜¯æˆ‘ä»¬è‡ªå·±åŠ è½½å€¼ï¼Œè¿™æ—¶æˆ‘ä»¬ä¾èµ–ç”¨æˆ·æä¾›çš„ `CacheLoader`ã€‚å¦‚æœæ”¯æŒä¸­æ–­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ”¯æŒï¼Œå¦åˆ™çš„è¯ï¼Œå°±ä¸æ”¯æŒã€‚

æ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸æä¾›ä¸€ä¸ªæ”¯æŒä¸­æ–­çš„ `CacheLoader`ï¼Ÿä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åšäº† (è§ä¸‹æ–‡)ï¼šå¦‚æœ `CacheLoader` æŠ›å‡º `InterruptedException`ï¼Œé‚£ä¹ˆæ‰€æœ‰å¯¹ key çš„ `get` è°ƒç”¨ä¼šè¿…é€Ÿè¿”å›(å°±åƒå…¶å®ƒçš„å¼‚å¸¸ä¸€æ ·)ã€‚å¦å¤–ï¼Œ`get` ä¼šæ¢å¤åŠ è½½çº¿ç¨‹ä¸­çš„ä¸­æ–­ä½ã€‚ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œ`InterruptedException` è¢«åŒ…è£¹åœ¨ `ExecutionException` å†…ã€‚

åŸåˆ™ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬ä¸èƒ½ä¸ºä½ åŒ…è£¹å¼‚å¸¸ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œè¿™å°†ä¼šå¼ºåˆ¶æ‰€æœ‰ä½¿ç”¨ `LoadingCache`Â çš„ç”¨æˆ·å»å¤„ç† `InterruptedException`ï¼Œå³ä½¿å¤§å¤šæ•° `CacheLoader` å®ç°ä»æ¥ä¸ä¼šæŠ›å‡ºå®ƒã€‚ä½†æ˜¯è€ƒè™‘æ‰€æœ‰*éåŠ è½½*çš„çº¿ç¨‹åœ¨ç­‰å¾…æ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆè¿™å¯èƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚ä½†æ˜¯å¤§å¤šæ•°çš„ç¼“å­˜éƒ½æ˜¯åº”ç”¨åœ¨å•çº¿ç¨‹ä¸­ã€‚å®ƒä»¬çš„ä½¿ç”¨è€…ä»ç„¶éœ€è¦æ•è·ä¸å¯èƒ½å‘ç”Ÿçš„ `InterruptedException`ã€‚å³ä½¿ä½¿ç”¨è€…åœ¨å¤šçº¿ç¨‹ä¸­å…±äº«ç¼“å­˜æ•°æ®ï¼Œæœ‰æ—¶å€™ä½¿ç”¨è€…ä¸­æ–­ *get* è°ƒç”¨ï¼Œä¹Ÿæ˜¯åŸºäºå“ªä¸ªçº¿ç¨‹å…ˆå‘å‡ºè¯·æ±‚ã€‚

æˆ‘ä»¬åŸºäºè¿™ä¸ªå†³å®šçš„æŒ‡å¯¼æ–¹é’ˆæ˜¯ç¼“å­˜çš„è¡¨ç°å°±åƒæ‰€æœ‰çš„å€¼åœ¨è°ƒç”¨çš„çº¿ç¨‹ä¸­åŠ è½½çš„ä¸€æ ·ã€‚è¿™ä¸ªåŸç†å°†ç¼“å­˜å¼•è¿›åˆ°ä»£ç ä¸­å˜å¾—ç®€å•ï¼Œè¯¥ä»£ç åœ¨æ¯æ¬¡è°ƒç”¨ä¹‹å‰éƒ½ä¼šé‡æ–°è®¡ç®—å®ƒçš„å€¼ã€‚å¦‚æœæ—§çš„ä»£ç ä¸èƒ½è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆæ–°çš„ä»£ç ä¹Ÿä¸ä¼šè¢«ä¸­æ–­ã€‚

"åœ¨æŸç§æ„ä¹‰ä¸Š"ï¼Œæˆ‘è¯´æˆ‘ä»¬æ”¯æŒä¸­æ–­ã€‚ä»ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬ä¸æ”¯æŒä¸­æ–­ï¼Œè¿™è®© `LoadingCache` æˆä¸ºäº†ä¸€ç§æœ‰æ¼æ´çš„æŠ½è±¡ã€‚å¦‚æœåŠ è½½çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œæˆ‘ä»¬åƒå¤„ç†å…¶å®ƒå¼‚å¸¸ä¸€æ ·å¤„ç†å®ƒã€‚è¿™åœ¨å¤§å¤šæ•°çš„æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œä½†æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹è°ƒç”¨ `get` æ–¹æ³•ç­‰å¾…è·å–å€¼æ—¶ï¼Œè¿™æ˜¯ä¸å¯¹çš„ã€‚è™½ç„¶è®¡ç®—è¯¥å€¼çš„æ“ä½œè¢«ä¸­æ–­äº†ï¼Œä½†æ˜¯è·å–è¯¥å€¼çš„æ“ä½œå´æ²¡æœ‰ã€‚ç„¶è€Œï¼Œæ‰€æœ‰çš„è¿™äº›è°ƒç”¨è€…éƒ½ä¼šæ”¶åˆ° `InterruptedException` (åŒ…è£¹åœ¨ `ExecutionException` ä¸­)ï¼Œå°½ç®¡å¹¶æ²¡æœ‰åƒ "å–æ¶ˆ" ä¸€æ ·ï¼Œæœ‰è¿™ä¹ˆå¤šçš„ "å¤±è´¥"ã€‚æ­£ç¡®çš„è¡Œä¸ºåº”è¯¥æ˜¯å‰©ä½™çº¿ç¨‹å…¶ä¸­ä¸€ä¸ªé‡æ–°åŠ è½½ã€‚æ‰€ä»¥ï¼Œè¿™æœ‰ä¸€ä¸ª [bug](https://github.com/google/guava/issues/1122)ã€‚ä½†æ˜¯ï¼Œä¿®å¤æ˜¯æœ‰é£é™©çš„(æ‰€ä»¥ä¸€ä¸ª 2014 çš„ bugï¼Œç°åœ¨è¿˜æ²¡æœ‰ä¿®å¤ ğŸ™„)ã€‚æ‰€ä»¥æˆ‘ä»¬å¹¶ä¸æ‰“ç®—ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œè€Œæ˜¯è®¡åˆ’å°†ç²¾åŠ›æ”¾åœ¨ `AsyncLoadingCache` ä¸Šï¼Œå®ƒå°†è¿”å›ä¸€ä¸ª `Future` å¯¹è±¡ï¼Œå¹¶ä¸”å…·æœ‰æ­£ç¡®çš„ä¸­æ–­è¡Œä¸ºã€‚

